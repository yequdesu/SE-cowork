<view class="container">
  
  <!-- å¼•å…¥ WXS å·¥å…· -->
  <wxs module="tools">
    module.exports.includes = function(arr, item) {
      return arr.indexOf(item) > -1;
    }
  </wxs>

  <!-- é¡¶éƒ¨ Header -->
  <view class="header fade-in">
    <view class="header-left">
      <text class="title">å­¦ç”Ÿåå†Œ</text>
      <text class="subtitle">å…± {{students.length}} ä½æˆå‘˜åœ¨æ¡£</text>
    </view>
    
    <!-- é¡¶éƒ¨æ“ä½œåŒº -->
    <view class="header-right">
      <!-- åˆ‡æ¢å¤šé€‰æ¨¡å¼ -->
      <view 
        class="btn-mode {{isMultiSelectMode ? 'active' : ''}}" 
        bindtap="toggleMultiSelectMode"
        hover-class="btn-hover"
      >
        <text>{{isMultiSelectMode ? 'å®Œæˆ' : 'ç®¡ç†'}}</text>
      </view>

      <!-- æ·»åŠ æŒ‰é’® (ä»…åœ¨æ™®é€šæ¨¡å¼æ˜¾ç¤º) -->
      <view 
        wx:if="{{!isMultiSelectMode}}" 
        class="btn-add" 
        bindtap="showAddModal"
        hover-class="btn-hover"
      >
        <text class="icon-plus">+</text> æ–°å¢
      </view>
    </view>
  </view>

  <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  (åŠ¨ç”»æ˜¾éš) -->
  <view class="batch-toolbar {{isMultiSelectMode ? 'show' : ''}}">
    <view class="toolbar-content">
      <view class="check-all-group" bindtap="toggleSelectAll">
        <view class="custom-checkbox {{selectAll ? 'checked' : ''}}">
          <text class="check-icon">âœ“</text>
        </view>
        <text>å…¨é€‰</text>
      </view>
      
      <button 
        class="btn-batch-delete {{selectedStudents.length > 0 ? '' : 'disabled'}}" 
        bindtap="batchDelete" 
        disabled="{{selectedStudents.length === 0}}"
        hover-class="btn-danger-hover"
      >
        åˆ é™¤é€‰ä¸­ ({{selectedStudents.length}})
      </button>
    </view>
  </view>

  <!-- å­¦ç”Ÿåˆ—è¡¨ -->
  <scroll-view scroll-y class="list-container" wx:if="{{students.length > 0}}">
    <view class="list-wrapper slide-up" style="animation-delay: 0.1s;">
      
      <view
        wx:for="{{students}}"
        wx:key="student_id"
        class="student-card {{isMultiSelectMode ? 'mode-select' : ''}} {{tools.includes(selectedStudents, item.student_id) ? 'is-selected' : ''}}"
        bindtap="{{isMultiSelectMode ? 'toggleStudentSelection' : ''}}" 
        data-id="{{item.student_id}}"
        hover-class="card-hover"
        hover-stay-time="100"
      >
        <!-- 1. å¤šé€‰æ¡†åŒºåŸŸ -->
        <view class="checkbox-wrapper" wx:if="{{isMultiSelectMode}}">
          <view class="custom-checkbox {{tools.includes(selectedStudents, item.student_id) ? 'checked' : ''}}">
            <text class="check-icon">âœ“</text>
          </view>
        </view>

        <!-- 2. å¤´åƒåŒºåŸŸ -->
        <view class="avatar-box">
          <text>{{item.name[0]}}</text>
        </view>

        <!-- 3. ä¿¡æ¯åŒºåŸŸ -->
        <view class="info-box">
          <view class="info-top">
            <text class="name">{{item.name}}</text>
            <view class="tag-major">{{item.major}}</view>
          </view>
          <text class="id-text">ID: {{item.student_id}}</text>
        </view>

        <!-- 4. å•ä¸ªæ“ä½œåŒºåŸŸ (ä»…æ™®é€šæ¨¡å¼) -->
        <view class="actions-box" wx:if="{{!isMultiSelectMode}}">
          <view class="btn-icon edit" catchtap="editStudent" data-student="{{item}}" hover-class="icon-hover">
            <text>âœ</text>
          </view>
          <view class="btn-icon delete" catchtap="deleteStudent" data-id="{{item.student_id}}" hover-class="icon-hover">
            <text>Ã—</text>
          </view>
        </view>

      </view>

      <!-- åº•éƒ¨å«ç‰‡ -->
      <view style="height: 60rpx;"></view>
    </view>
  </scroll-view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:else class="empty-state fade-in">
    <view class="empty-icon-bg">ğŸ“‡</view>
    <text class="empty-txt">æš‚æ— å­¦ç”Ÿåå•</text>
    <text class="empty-sub">ç‚¹å‡»å³ä¸Šè§’â€œæ–°å¢â€æŒ‰é’®æ·»åŠ </text>
  </view>

  <!-- Loading -->
  <view wx:if="{{loading}}" class="loading-overlay fade-in">
    <view class="spinner"></view>
  </view>

  <!-- å¼¹çª— Modal -->
  <view wx:if="{{showModal}}" class="modal-mask fade-in" bindtap="hideModal">
     <view class="modal-content slide-up" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">{{isEditing ? 'ç¼–è¾‘ä¿¡æ¯' : 'å½•å…¥æ–°å­¦ç”Ÿ'}}</text>
      </view>
      
      <view class="form-group">
        <text class="label">å­¦å·</text>
        <input
          class="input-field"
          placeholder="è¯·è¾“å…¥å­¦å·"
          value="{{currentStudent.student_id}}"
          bindinput="onStudentIdInput"
          type="number"
          placeholder-class="ph-color"
          disabled="{{isEditing}}"
        />
      </view>

      <view class="form-group">
        <text class="label">å§“å</text>
        <input 
          class="input-field" 
          placeholder="è¯·è¾“å…¥å§“å" 
          value="{{currentStudent.name}}" 
          bindinput="onNameInput" 
          placeholder-class="ph-color"
        />
      </view>

      <view class="form-group">
        <text class="label">ä¸“ä¸šç­çº§</text>
        <input 
          class="input-field" 
          placeholder="ä¾‹å¦‚ï¼šè®¡ç®—æœº2301" 
          value="{{currentStudent.major}}" 
          bindinput="onMajorInput" 
          placeholder-class="ph-color"
        />
      </view>

      <view class="modal-actions">
        <button class="btn-cancel" bindtap="hideModal">å–æ¶ˆ</button>
        <button class="btn-save" bindtap="saveStudent">ä¿å­˜ä¿¡æ¯</button>
      </view>
    </view>
  </view>

</view>