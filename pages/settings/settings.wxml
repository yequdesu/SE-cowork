<view class="container">
  
  <!-- ã€æ ¸å¿ƒä¿®å¤ã€‘å¼•å…¥ WXS è„šæœ¬ç”¨äºåˆ¤æ–­æ•°ç»„åŒ…å«é€»è¾‘ -->
  <wxs module="tools">
    module.exports.includes = function(arr, item) {
      // WXS ä¸­ä¸æ”¯æŒ ES6 çš„ .includesï¼Œå¿…é¡»ä½¿ç”¨ .indexOf
      return arr.indexOf(item) > -1;
    }
  </wxs>

  <!-- é¡¶éƒ¨å¤§æ ‡é¢˜ä¸ä¸»æ“ä½œ -->
  <view class="header-section">
    <view class="title-group">
      <text class="page-title">å­¦ç”Ÿç®¡ç†</text>
      <text class="page-subtitle">å…± {{students.length}} ä½å­¦ç”Ÿ</text>
    </view>
    
    <!-- æŒ‰é’®ç»„ -->
    <view class="header-actions">
      <!-- å¤šé€‰æ¨¡å¼åˆ‡æ¢æŒ‰é’® (æ¬¡è¦) -->
      <view class="btn-secondary-capsule" bindtap="toggleMultiSelectMode" hover-class="btn-hover-light">
        <text>{{isMultiSelectMode ? 'å–æ¶ˆ' : 'å¤šé€‰'}}</text>
      </view>
      
      <!-- æ·»åŠ æŒ‰é’® (ä¸»è¦) - ä»…åœ¨éå¤šé€‰æ¨¡å¼ä¸‹æ˜¾ç¤º -->
      <view class="btn-primary-capsule" bindtap="showAddModal" hover-class="btn-hover" wx:if="{{!isMultiSelectMode}}">
        <text class="icon-plus">+</text> æ·»åŠ 
      </view>
    </view>
  </view>

  <!-- å¤šé€‰æ¨¡å¼ä¸“ç”¨å·¥å…·æ  (åŠ¨ç”»æ˜¾éš) -->
  <view class="toolbar-wrapper {{isMultiSelectMode ? 'show' : ''}}">
    <view class="toolbar">
      <view class="checkbox-row" bindtap="toggleSelectAll">
        <view class="circle-checkbox {{selectAll ? 'checked' : ''}}">
          <text wx:if="{{selectAll}}" class="check-mark">âœ“</text>
        </view>
        <text class="toolbar-text">å…¨é€‰</text>
      </view>
      
      <button 
        class="btn-batch-delete {{selectedStudents.length > 0 ? 'active' : ''}}" 
        bindtap="batchDelete" 
        disabled="{{selectedStudents.length === 0}}"
      >
        åˆ é™¤ ({{selectedStudents.length}})
      </button>
    </view>
  </view>

  <!-- å­¦ç”Ÿåˆ—è¡¨ -->
  <scroll-view scroll-y class="list-container" wx:if="{{students.length > 0}}">
    <view
      wx:for="{{students}}"
      wx:key="student_id"
      class="student-card {{isMultiSelectMode ? 'multi-mode' : ''}} {{tools.includes(selectedStudents, item.student_id) ? 'card-selected' : ''}}"
      bindtap="{{isMultiSelectMode ? 'toggleStudentSelection' : ''}}" 
      data-id="{{item.student_id}}"
    >
      <!-- å·¦ä¾§å¤é€‰æ¡† (ä»…å¤šé€‰æ¨¡å¼æ˜¾ç¤º) -->
      <view class="selection-area" wx:if="{{isMultiSelectMode}}">
        <!-- ã€æ ¸å¿ƒä¿®å¤ã€‘ä½¿ç”¨ tools.includes åˆ¤æ–­é€‰ä¸­çŠ¶æ€ -->
        <view class="circle-checkbox {{tools.includes(selectedStudents, item.student_id) ? 'checked' : ''}}">
          <text wx:if="{{tools.includes(selectedStudents, item.student_id)}}" class="check-mark">âœ“</text>
        </view>
      </view>

      <!-- å¤´åƒ -->
      <view class="avatar-placeholder">
        {{item.name[0]}}
      </view>

      <!-- ä¿¡æ¯ -->
      <view class="card-info">
        <view class="name-row">
          <text class="student-name">{{item.name}}</text>
          <text class="student-major">{{item.major}}</text>
        </view>
        <text class="student-id">ID: {{item.student_id}}</text>
      </view>

      <!-- å³ä¾§æ“ä½œæŒ‰é’® (ä»…æ™®é€šæ¨¡å¼æ˜¾ç¤º) -->
      <view class="action-group" wx:if="{{!isMultiSelectMode}}">
        <view class="icon-btn edit" catchtap="editStudent" data-student="{{item}}" hover-class="icon-hover">
          âœ
        </view>
        <view class="icon-btn delete" catchtap="deleteStudent" data-id="{{item.student_id}}" hover-class="icon-hover">
          âœ•
        </view>
      </view>
    </view>
    
    <!-- åº•éƒ¨å®‰å…¨åŒºå«ç‰‡ -->
    <view class="safe-area-spacer"></view>
  </scroll-view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:else class="empty-state">
    <view class="empty-illustration">ğŸ“‡</view>
    <text class="empty-title">æš‚æ— åå•</text>
    <text class="empty-desc">ç‚¹å‡»å³ä¸Šè§’æ·»åŠ å­¦ç”Ÿï¼Œæˆ–å¯¼å…¥ Excel</text>
  </view>

  <!-- Loading é®ç½© -->
  <view wx:if="{{loading}}" class="loading-mask">
    <view class="spinner"></view>
  </view>

  <!-- Modal å¼¹çª— (æ·»åŠ /ç¼–è¾‘) -->
  <view wx:if="{{showModal}}" class="modal-backdrop" bindtap="hideModal">
     <view class="modal-card" catchtap="stopPropagation">
      <text class="modal-header">{{isEditing ? 'ç¼–è¾‘ä¿¡æ¯' : 'æ–°æ·»æˆå‘˜'}}</text>
      
      <view class="form-item">
        <text class="label">å­¦å·</text>
        <input 
          class="input-control" 
          placeholder="ä¾‹å¦‚: 2023001" 
          value="{{currentStudent.student_id}}" 
          bindinput="onStudentIdInput" 
          disabled="{{isEditing}}" 
          type="number" 
          placeholder-class="ph-style"
        />
      </view>

      <view class="form-item">
        <text class="label">å§“å</text>
        <input 
          class="input-control" 
          placeholder="å­¦ç”Ÿå§“å" 
          value="{{currentStudent.name}}" 
          bindinput="onNameInput" 
          placeholder-class="ph-style"
        />
      </view>

      <view class="form-item">
        <text class="label">ä¸“ä¸š/ç­çº§</text>
        <input 
          class="input-control" 
          placeholder="ä¾‹å¦‚: è®¡ç®—æœºç§‘å­¦" 
          value="{{currentStudent.major}}" 
          bindinput="onMajorInput" 
          placeholder-class="ph-style"
        />
      </view>

      <view class="modal-footer">
        <button class="btn-ghost" bindtap="hideModal">å–æ¶ˆ</button>
        <button class="btn-primary" bindtap="saveStudent">ä¿å­˜</button>
      </view>
    </view>
  </view>
</view>